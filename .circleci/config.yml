version: 2.1

orbs:
  aws-s3: circleci/aws-s3@1.0.11

executors:
  emacs26:
    working_directory: ~/blog
    docker:
      - image: silex/emacs:master-dev
  python3:
    docker:
      - image: circleci/python:3.7

commands:
  configure-emacs:
    steps:
      - run:
          name: "Checkout Emacs Config"
          command: |
            if test -d ~/.config ; then
              cd ~/.config && git pull
            else
              git clone https://github.com/stig/.config.git ~/.config
            fi
      - run:
          name: "Tangle relevant Emacs config files"
          command: >
            emacs --batch
            --eval "(require 'ob-tangle)"
            --eval '(org-babel-tangle-file "~/.config/emacs/README.org")'
            --eval '(org-babel-tangle-file "~/.config/emacs/Blogging.org")'
      - run:
          name: "Byte-compile emacs config"
          command: emacs --batch --load ~/.config/emacs/init.el

jobs:
  build:
    executor: emacs26
    steps:
      - checkout
      - restore_cache:
          keys:
            - v6-org-{{ .Branch }}
            - v6-org-trunk
      - configure-emacs
      - run:
          name: Tangle CSS
          command: >
            emacs --batch
            --eval "(require 'ob-tangle)"
            --eval '(org-babel-tangle-file "etc/style.org")'
# TODO: Tangle to a different file above, and insert a "dropcss" step here to remove unnused styles
      - run:
          name: Publish Blog
          command: >
            emacs --batch
            --load ~/.config/emacs/init.el
            --eval "(setq clojure-mode-hook nil)"
            --eval "(setq prog-mode-hook nil)"
            --eval "(setq text-mode-hook nil)"
            --funcall org-publish-all
      - store_artifacts:
          path: ~/public_html
      - save_cache:
          key: v6-org-{{ .Branch }}-{{ .Revision }}
          paths:
            - ~/.config
      - persist_to_workspace:
          root: ~/public_html
          paths:
            - '*'

  deploy:
    executor: python3
    steps:
      - attach_workspace:
          at: ~/public_html
      - aws-s3/sync:
          from: ~/public_html
          to: 's3://www.brautaset.org'
          arguments: >-
            --delete
            --exclude '*'
            --include '*.png'
            --include '*.pdf'
            --include '*.jpg'
            --include '*.html'
            --include '*.css'
            --include '*.xml'
            --acl public-read
            --cache-control "max-age=86400"
      - run: >-
          aws cloudfront create-invalidation
          --distribution-id E2HQ2C8QF1FXUZ
          --paths '/*'

workflows:
  version: 2

  pr:
    jobs:
      - build:
          filters:
            branches:
              ignore: trunk

  deploy:
    jobs:
      - build:
          filters:
            branches:
              only: trunk
      - deploy:
          requires:
            - build
