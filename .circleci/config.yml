version: 2.1

orbs:
  aws-s3: circleci/aws-s3@1.0.11

executors:
  nixos:
    working_directory: ~/blog
    docker:
      - image: nixos/nix
        auth: &auth
          username: stigbra
          password: $DOCKERHUB_PASSWORD
  python3:
    docker:
      - image: circleci/python:3.7
        auth: *auth

jobs:
  build:
    executor: nixos
    steps:
      - checkout
      - run: nix-channel --add https://github.com/stig/nixpkgs/archive/ox-rss.tar.gz ox-rss
      - run: nix-channel --update
      - run: nix-channel --list
      - run:
          name: Tangle CSS
          command: nix-shell --run tangle-css
      - run:
          name: Publish Blog
          command: nix-shell --run publish-blog
      - store_artifacts:
          path: ~/blog/_site
          destination: html
      - persist_to_workspace:
          root: ~/blog
          paths:
            - '_site'

  check-links:
    executor: nixos
    steps:
      - attach_workspace:
          at: ~/blog
      - restore_cache:
          key: v1-lychee
      - run: nix-shell -p lychee --run "lychee -b _site _site"
      - save_cache:
          key: v1-lychee
          paths: ".lycheecache"

  deploy:
    executor: python3
    steps:
      - attach_workspace:
          at: ~/blog
      - aws-s3/sync:
          from: ~/blog/_site
          to: 's3://www.brautaset.org'
          arguments: >-
            --delete
            --acl public-read
            --cache-control "max-age=86400"
      - run: >-
          aws cloudfront create-invalidation
          --distribution-id E2HQ2C8QF1FXUZ
          --paths '/*'

workflows:
  version: 2

  pr:
    jobs:
      - build:
          filters:
            branches:
              ignore: trunk
      - check-links:
          requires:
            - build

  deploy:
    jobs:
      - build:
          filters:
            branches:
              only: trunk
      - check-links:
          requires:
            - build
      - deploy:
          requires:
            - build
