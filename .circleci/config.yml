version: 2.1

executors:
  nixos:
    working_directory: ~/blog
    docker:
      - image: nixos/nix
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD

commands:
  enable-flakes:
    steps:
      - run: mkdir -p ~/.config/nix
      - run: echo "experimental-features = nix-command flakes" > ~/.config/nix/nix.conf

jobs:
  build:
    executor: nixos
    steps:
      - checkout
      - enable-flakes
      - run:
          name: Tangle CSS
          command: nix run .#tangle-css
      - run:
          name: Publish Blog
          command: nix run .#publish-blog
      - store_artifacts:
          path: ~/blog/_site
          destination: html
      - persist_to_workspace:
          root: ~/blog
          paths:
            - '_site'

  check-links:
    executor: nixos
    steps:
      - attach_workspace:
          at: ~/blog
      - restore_cache:
          key: v1-lychee
      - run: nix-shell -p lychee --run "lychee -b _site _site"
      - save_cache:
          key: v1-lychee
          paths: ".lycheecache"

  deploy:
    executor: nixos
    steps:
      - attach_workspace:
          at: ~/blog
      - run: nix-env -iA nixpkgs.awscli2
      - run: >-
          aws s3 sync ~/blog/_site 's3://www.brautaset.org/'
          --delete
          --acl public-read
          --cache-control "max-age=86400"
      - run: >-
          aws cloudfront create-invalidation
          --distribution-id E2HQ2C8QF1FXUZ
          --paths '/*'

workflows:
  version: 2

  pr:
    jobs:
      - build:
          filters:
            branches:
              ignore: trunk
      - check-links:
          requires:
            - build

  deploy:
    jobs:
      - build:
          filters:
            branches:
              only: trunk
      - check-links:
          requires:
            - build
      - deploy:
          requires:
            - build
